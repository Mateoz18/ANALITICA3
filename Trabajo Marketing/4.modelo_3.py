# -*- coding: utf-8 -*-
"""4. Modelo_3.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1jq3MGbD4Z4fXuVKxP1gJxdGr0-W55H3g

# <font color='056938'> **Librerias** </font>
"""

from google.colab import drive
import sys
import os
import numpy as np
import pandas as pd
import sqlite3 as sql
from ipywidgets import interact ## para análisis interactivo
from sklearn.neighbors import NearestNeighbors
from sklearn.metrics.pairwise import cosine_distances
from ipywidgets import interact
from sklearn.base import BaseEstimator, TransformerMixin
from sklearn.pipeline import Pipeline
from sklearn import set_config

drive.mount('/content/drive')

#Define la parte del directorio que quieres trabajar
path = "/content/drive/MyDrive/Mod2/ANALITICA3"

sys.path.append(path)##para importar archivo de funciones propias a traves de import
os.chdir(path)## para que por defecto suba y descargue archivos partiendo de esa ruta
sys.path.append(f"{path}") #agragarle al path, poder leer

"""# <font color='056938'> **Cargar base de datos** </font>"""

con=sql.connect("data//db_movies")# conectarse a base de datos existente
cur=con.cursor()#otro tipo de conexión para ejecutar consultas en la base de datos sin traer ni llevar información

cur.execute("""SELECT name FROM sqlite_master WHERE type='table'""")
cur.fetchall()

tabla_completa = pd.read_sql("SELECT * FROM full_ratings", con)
tabla_completa.head()

"""# <font color='056938'> **Sistema de recomendación basado en ítems** </font>

Este sistema usa las similitudes entre las películas basadas en las calificaciones de los usuarios. Si los usuarios que han calificado una película también han calificado otras de manera similar, esas otras películas son recomendadas.

Para esto, se construye un **pipeline** que contiene los siguientes pasos:

**Paso 1. Construcción de la matriz película-usuario**: Se construye una matriz de película-usuario con los ratings disponibles. Esta matriz tiene como filas las películas y como columnas los usuarios, donde cada celda contiene la calificación (rating) que un usuario ha dado a una película. Si un usuario no ha valorado una película, se asigna un valor de cero.

**Paso 2. Modelo KNN con métrica de similitud coseno**: Se entrena un modelo **K-Nearest Neighbors (KNN)** utilizando la similitud del coseno como métrica. Este modelo permite identificar películas similares entre sí, comparando vectores de calificaciones. La similitud del coseno mide el ángulo entre los vectores, por lo que dos películas son consideradas similares si fueron calificadas de manera parecida por los mismos usuarios, independientemente de la magnitud de las calificaciones.

**Ejemplo de la similitud del coseno**: Tenemos 3 usuarios y las siguientes calificaciones:

![image.png](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAtIAAACoCAYAAADNTAkkAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAACDaSURBVHhe7d19dFTVvcbxB4FbZJgZIy9JhHitlYSmoQZdl7ZCc00rjRNsmRYoDcsXwIaU25WKBK9ctY0UFuZay1CwQhJEFrSgDdrYKlObSmxA6xtlMDFiQrUQdCa+1QwMoSDs+0/m3MxJJOEAtiXfz1pZC/b+nTOTxew5z9lnn0M/Y4wRAAAAgFNynr0BAAAAQM8I0gAAAIADBGkAAADAAYI0AAAA4ABBGgAAAHCAIA0AAAA4QJAGAAAAHCBIAwAAAA4QpAEAAAAHCNIAAACAA46CdDAYlMfjsX6GDh2q4uJitba22ku7CIVCSk5OViAQkCQZY7RixQr5fL5ebf9x7PsFkCgSiSgzM1NFRUW9aj/bjDF64IEHNHXqVH3wwQf27lOyb98+jRkzRsnJyQqFQvZuoFuxWEz5+fnKz89XLBbrsf2T8MQTTygvL0979+61d/VKIBDocnxetGiRDh8+bC8FEgQCgW6/Qz+u/WxraWnR5MmT9atf/cre1WvGGD377LP62te+pgsuuEAej0cpKSl6+OGH7aWOOQrScfPnz9eGDRt0yy23aNOmTSouLlZ7e7u97KR+85vfKBgMau3atUpOTrZ3AzhHHT9+XM3Nzdq3b98pf2/YvfDCC5KkpKQkBYNBezfwL+PNN9/Ua6+9dloBfsCAAVq8eLE2bNigGTNm6IEHHtDPfvYzexnwT+2DDz5QfX2940lWY4zuv/9++Xw+HThwQHfddZfWrVunG2+88bSPOZ2dVpD+0pe+JL/frx/96Ee65ZZb9MILL2j//v32spOaMmWKnnrqKY0cOdLeBeAcNmDAAAUCAb388sunNf7b29u1efNmff3rX9fMmTP1u9/9Th9++KG9DPiXUFxcrP379+vyyy+3d/XawIEDlZubax2fR40apbfeesteBvxTu/zyy7V//34VFxfbu3rlT3/6kxYvXqwbb7xRO3fu1MKFCzVt2jTde++9mj17tr3csdMK0p0NHjzY+vOxY8e0atUqpaWlyePx6Atf+IJeeeWVhPq4oqIiZWZmKhKJSJIOHjyo22+/XUOHDpXH49E111yjDz74oEtdT5ejX375ZX31q1+1Lm9de+21fJEAvbB//35NnjzZGjuFhYU6cuSItaSr84xv53HZ3t6uH//4x9a4T05O1tq1a2WMscbr9OnTNXv2bF100UUKhUJdxnVra6uKi4ut8Z+RkaFHH31UxphO7zDRm2++qVdeeUX5+fn68pe/rIaGBu3atcteBjjW3t6uu+++2/pcjhs3Tnv37u1xTHz00Udau3atMjIy5PF4dMEFF+juu+/WsWPHrNoxY8ZY+w4EAl0uox87dkwVFRXWPk5lqcbx48e1Y8cOvf/++5o6daq9Gzhlx48fV0VFhfU9n5aWpueee67b5bX2z/LJclm89p577tHIkSNVVFTUZZ/GGD3++OO68sorrfE0a9asbmesjTHauHGjhg0bpttuu03nn3++veSMOe0gbYzRK6+8og0bNuiKK65QWlqafv7zn6u0tFSLFy/WSy+9pKSkJBUWFurdd9+1b54gFovp+uuv1/r163XPPffo+eef17XXXqvjx4/bS3tUX1+vm266Sa+99ppWrFih559/XkuXLj3pARno644cOaIFCxbozTff1NNPP626ujpdcMEFvRqDBw8eVDQa1datW/XSSy9p3LhxuvPOO7V7926rpqamRtddd53eeustZWdnJ2wfjUZVWFiop59+WuXl5aqrq9PYsWN18803n3S5xuOPP66kpCR97nOf0+c//3l95jOf0ZNPPslYxxmzefNmBQIBlZWV6dVXX9U3vvGNXi29+Pvf/6433nhDDz30kF599VVNnTpVy5cvV01NjVXz9ttv67333tOBAwd06623JmxvjNHPf/5zLVq0SDfccIOef/55LVy4UGvWrNGdd96pjz76KKE+rr29XTk5OUpKStIPfvAD3XPPPcrJybGXAaesrq5Ot912m26++Wa9+uqrmj9/fq+XSfSUy9rb2/Xss8+qoaFB5eXl9s31m9/8RrNnz9YXvvAFPfvss1qxYoWCwaDmzp3bZTwePnxY+/bt06WXXqphw4Yl9J1ppxWkZ8yYIa/Xq4kTJ+rf/u3fVFZWpkOHDmndunWaM2eOZs+erYyMDN1+++16/fXXe1yo/uKLL+qZZ57R8uXLNXfuXGVmZmrhwoUaPny4vbRHs2fP1o033qiRI0dqxowZuuqqq7Rv375encUDkPr376+xY8eqrKws4YrTxxkxYoTuu+8+jR07VhkZGbrlllvU3t6ucDhs1VxzzTWaPHmy+vXrl7CtOtY5//GPf9SPf/xjTZs2TdnZ2XrggQd02WWXafPmzd2Ghmg0qpqaGv3Hf/yHhg8frgsvvFA5OTkKBoMJrwucKcOHD9fdd9+trKwse1cXLpdLy5Yt01VXXaW0tDQVFxfr/PPP1+uvv27VJCUlWe127777rtatWye/369FixYpMzNTixYt0ne/+1098cQTOnDggH0TybZG+nvf+55uu+02LVy4sNsxBDjl9Xq1YMECXX311faubvWUy/r166eSkhIlJSXZN9Xhw4f14IMPKjs7W2VlZRo7dqxmzZqlJUuWaPv27R+76uGTcFpBev78+dq0aZN2796tF154QRkZGXr77bfV2tqqiooKeb1eeTweTZkyRSdOnOhxEL/66qsaNGiQPve5z9m7TtmePXv0ve99T5///Od18cUXa8eOHfYSAB2X6k6cOKGBAwdq0KBBKisrU2pqqq6++mqNHj06YfbsZNrb2/XQQw/pK1/5ii699FLNmDHDXqKhQ4dq0KBB9mZJ0uuvv65Bgwbpsssus9pcLpdGjBih999/X3//+98T6iVp586d2rlzp375y1/K6/XK6/WqoqJCLS0teu655+zlQK8YY3T8+HENGDBA/fr103e+8x0rkKakpKi0tFRHjx61b9bF8ePH9fjjj+sb3/iG0tPTlZOT02X2zuVyyev1JrTFtba26r333tPYsWM1YMAAqSNsjBw5UtFo9GPvBei8RvqHP/yhZs+eraeeekrvvfeevRTo0fHjx9W/f3/1799fEydO1NKlS7V69WqNGjVKN998s6LRqH2TbvWUywYNGtRtiJakQ4cO6a9//atGjx4tj8djtaelpemjjz7qMhY+9alPaejQoXrnnXe6zFafaacVpL/0pS/puuuu06c//Wn1799fknTRRRcpOTlZc+fOVVNTU8JPbm6ufRcJMjIydOTIkW4f+zNw4EAdO3ZMR44ckTod/Luzb98++f1+HTp0SL/+9a+1e/duTZw40V4G9CmDBg3S8OHDtXPnTr3zzjtW+2uvvaZwOKwrrrhCknTZZZfp6aefVn19vdLT0zV//nzt37/fOpAfPHhQ6ggbnU+OV6xYoUWLFum//uu/9Pzzz2vjxo1WX290N/5jsZjeeecd/fu//3uXWXFjjJ588kkNHTpU999/vzZs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)

* Toy Story y Monsters, fueron calificadas por los mismos usuarios (A y B). Sus ratings no son idénticos, pero la proporción entre ellos es parecida. Por eso, la similitud del coseno será alta entre ellas (vectores similares en dirección).

* Por otro lado, titanic solo fue calificada por B y C, con una lógica distinta.Entonces, su vector apunta en una dirección distinta, y tendrá baja similitud con Toy Story o Monsters.
"""

# Construcción de la matriz película-usuario
class movie_usuario_matriz(BaseEstimator, TransformerMixin):
    # Método fit: Este es el método que se usa para entrenar el transformador
    def fit(self, tabla_completa, y=None):
        return self
    # Método transform: Este es el método que se usa para transformar los datos de entrada y crear la matriz película-usuario.
    def transform(self, tabla_completa):
        movie_usuario_matriz = tabla_completa.pivot_table(index='movie_title', columns='user_id', values='movie_rating').fillna(0)
        return movie_usuario_matriz

# Pipeline completo
pipeline = Pipeline([
     #Paso 1. Construcción de la matriz película-usuario
    ('crear_matriz', movie_usuario_matriz()),
     #Paso 2. Modelo KNN con métrica de similitud coseno
    ('knn', NearestNeighbors(metric='cosine', algorithm='brute', n_neighbors=11))# 10 peliculas similares
])

# Llamar al paso 'crear_matriz' y aplicarle transform() a tus datos
movie_usuario_matriz = pipeline.named_steps['crear_matriz'].transform(tabla_completa)
movie_usuario_matriz

# Entrenar pipeline
pipeline.fit(tabla_completa)

"""<font color='056938'> **Visualización recomendación** </font>"""

# Función de recomendación sin pipeline como argumento de interact
def recomendar_interactivo(pelicula, n_recomendaciones=10):
    movie_usuario_matriz = pipeline.named_steps['crear_matriz'].transform(tabla_completa)

     #Busca el índice de la película seleccionada en la matriz.
    idx = movie_usuario_matriz.index.get_loc(pelicula)
    #Usa el modelo KNN ya entrenado para encontrar las películas más similares (el resultado incluirá la película original que luego se descarta)
    distances, indices = pipeline.named_steps['knn'].kneighbors(movie_usuario_matriz.iloc[[idx]], n_neighbors=n_recomendaciones+1)
    #Se omite la primera (que es la película original)
    recomendadas = movie_usuario_matriz.index[indices.flatten()[1:]]

    print(f"\n Recomendaciones similares según la película '{pelicula}':")
    print()
    for i, rec in enumerate(recomendadas, 1):
        print(f"{i}. {rec}")

# Widget interactivo con dropdown de películas
interact(
    recomendar_interactivo,
    pelicula=sorted(tabla_completa['movie_title'].unique()),
    n_recomendaciones=(1, 20)
);